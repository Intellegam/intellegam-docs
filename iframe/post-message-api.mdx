---
title: PostMessage API
description: Control the embedded chat IFrame programmatically using browser postMessage
---

# PostMessage API

Send messages and control the chat programmatically using the browser's `postMessage` API.

## Basic Usage

```javascript
const IFrame = document.getElementById('chat-IFrame');

IFrame.contentWindow.postMessage({
  type: "intellegam:host-control",
  action: "send",
  parts: [{ type: "text", text: "Your message" }]
}, "https://your-app.com"); // Use specific origin in production
```

## Message Structure

```typescript
{
  type: "intellegam:host-control",
  action: "send" | "append-attachments",
  parts: Array<TextPart | FilePart>
}
```

**Required fields:**
- `type`: Must be `"intellegam:host-control"`
- `action`: Action to perform - see [Event Types](./event-types)
- `parts`: Message parts following [AI SDK UIMessage format](https://ai-sdk.dev/docs/reference/ai-sdk-core/ui-message#fileuipart)

## Message Parts

### Text Part

```typescript
{ type: "text", text: string }
```

### File Part

```typescript
{
  type: "file",
  url: string,         // Base64 data URI
  mediaType: string,   // MIME type
  filename?: string
}
```

**Supported file types:** `image/png`, `image/jpeg`, `image/gif`, `image/webp`

**Limits:** 10 MB per file, 10 files maximum

## Converting Files to Base64

### From File Input

```javascript
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

const file = event.target.files[0];
const base64 = await fileToBase64(file);
```

### From Image URL

```javascript
async function imageUrlToBase64(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}
```

## Error Handling

Errors are shown via toast notifications in the IFrame. Invalid messages are silently ignored.

### Client-Side Validation

```javascript
function sendMessage(text, files = []) {
  if (!text || typeof text !== 'string') {
    console.error('Invalid text');
    return;
  }

  if (files.length > 10) {
    console.error('Too many files. Maximum is 10.');
    return;
  }

  const parts = [
    ...files.map(f => ({ type: "file", url: f.url, filename: f.filename, mediaType: f.mediaType })),
    { type: "text", text }
  ];

  IFrame.contentWindow.postMessage({
    type: "intellegam:host-control",
    action: "send",
    parts
  }, "https://your-app.com");
}
```

## Security Best Practices

### Use Specific Origin

```javascript
// ❌ Bad: Accepts from any origin
IFrame.contentWindow.postMessage(message, "*");

// ✅ Good: Specific origin only
IFrame.contentWindow.postMessage(message, "https://your-app.com");
```

### Validate IFrame Source

```javascript
const TRUSTED_ORIGIN = "https://your-app.com";

function sendMessageToChat(message) {
  const IFrame = document.getElementById('chat-IFrame');

  if (!IFrame.src.startsWith(TRUSTED_ORIGIN)) {
    console.error('Untrusted IFrame source');
    return;
  }

  IFrame.contentWindow.postMessage(message, TRUSTED_ORIGIN);
}
```

### Sanitize User Input

```javascript
function sanitizeText(text) {
  return text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
}
```

## Related Documentation

- [Event Types](./event-types) - Available actions and examples
- [Query Parameters](./query-params) - URL configuration
- [AI SDK UIMessage](https://ai-sdk.dev/docs/reference/ai-sdk-core/ui-message#fileuipart) - Message format spec
